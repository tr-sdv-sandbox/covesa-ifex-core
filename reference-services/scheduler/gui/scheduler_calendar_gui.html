<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFEX Service Scheduler - Calendar View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #1a73e8;
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: #34a853;
        }

        .btn-primary:hover {
            background: #2d9048;
        }

        /* Calendar Container */
        .calendar-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 256px;
            background: white;
            border-right: 1px solid #dadce0;
            padding: 16px;
            overflow-y: auto;
        }

        .date-navigator {
            margin-bottom: 24px;
        }

        .mini-calendar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 24px;
        }

        .service-list {
            margin-top: 24px;
        }

        .service-list h3 {
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 12px;
        }

        .service-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .service-item:hover {
            background: #f1f3f4;
        }

        .service-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        /* Main Calendar */
        .calendar-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #dadce0;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-right: 24px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #dadce0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #f1f3f4;
        }

        .current-date {
            font-size: 22px;
            color: #3c4043;
        }

        .view-selector {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 6px 12px;
            border: 1px solid #dadce0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #e8f0fe;
            color: #1a73e8;
            border-color: #1a73e8;
        }

        /* Calendar Grid */
        .calendar-grid {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .week-view {
            display: flex;
            min-height: 100%;
        }

        .time-column {
            width: 80px;
            border-right: 1px solid #dadce0;
            flex-shrink: 0;
        }

        .time-slot {
            height: 60px;
            border-bottom: 1px solid #f1f3f4;
            padding: 4px 8px;
            font-size: 12px;
            color: #70757a;
        }

        .days-container {
            flex: 1;
            display: flex;
        }

        .day-column {
            flex: 1;
            border-right: 1px solid #dadce0;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            height: 60px;
            border-bottom: 1px solid #dadce0;
            padding: 8px;
            text-align: center;
            background: #f8f9fa;
        }

        .day-name {
            font-size: 12px;
            color: #70757a;
            text-transform: uppercase;
        }

        .day-number {
            font-size: 24px;
            margin-top: 4px;
        }

        .day-number.today {
            background: #1a73e8;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .hour-slot {
            height: 60px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background 0.2s;
        }

        .hour-slot:hover {
            background: #f8f9fa;
        }

        /* Events */
        .event {
            position: absolute;
            left: 4px;
            right: 4px;
            background: #1a73e8;
            color: white;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
            transition: box-shadow 0.2s;
        }

        .event:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 20;
        }

        .event.climate {
            background: #34a853;
        }

        .event.vehicle {
            background: #fbbc04;
            color: #333;
        }

        .event.scheduler {
            background: #ea4335;
        }

        .event-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #dadce0;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 400;
            color: #3c4043;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #dadce0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .close {
            position: absolute;
            right: 24px;
            top: 24px;
            color: #5f6368;
            font-size: 24px;
            cursor: pointer;
        }

        .close:hover {
            color: #3c4043;
        }

        /* Service Selection */
        .service-selection {
            display: grid;
            gap: 12px;
        }

        .service-option {
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-option:hover {
            border-color: #1a73e8;
            background: #f8f9fa;
        }

        .service-option.selected {
            border-color: #1a73e8;
            background: #e8f0fe;
        }

        .service-name {
            font-weight: 500;
            color: #3c4043;
            margin-bottom: 4px;
        }

        .service-description {
            font-size: 14px;
            color: #5f6368;
        }

        .method-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e8eaed;
        }

        .method-item {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .method-item:hover {
            background: #f1f3f4;
        }

        .method-item.selected {
            background: #1a73e8;
            color: white;
        }

        /* Parameter Form */
        .parameter-form {
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #3c4043;
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .recurring-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .recurring-option {
            padding: 6px 12px;
            border: 1px solid #dadce0;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .recurring-option:hover {
            border-color: #1a73e8;
            background: #f8f9fa;
        }

        .recurring-option.selected {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        /* Status */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #3c4043;
            color: white;
            padding: 8px 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34a853;
            margin-right: 8px;
        }

        .status-indicator.offline {
            background: #ea4335;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #5f6368;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Struct group styling */
        .struct-group {
            border-left: 3px solid #1a73e8;
            padding-left: 16px;
            margin-left: 8px;
            margin-top: 12px;
        }

        .struct-group.nested {
            border-left-color: #ea4335;
        }

        .struct-label {
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                IFEX Service Scheduler
            </h1>
            <div class="header-controls">
                <button class="btn" onclick="refreshServices()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Refresh
                </button>
                <button class="btn btn-primary" onclick="showNewEventModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Create
                </button>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="calendar-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="date-navigator">
                    <input type="date" id="dateNavigator" class="form-control" onchange="navigateToDate(this.value)">
                </div>

                <div class="mini-calendar" id="miniCalendar">
                    <!-- Mini calendar will be populated by JS -->
                </div>

                <div class="service-list">
                    <h3>Available Services</h3>
                    <div id="serviceList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Calendar -->
            <div class="calendar-main">
                <div class="calendar-header">
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="navigateWeek(-1)">â€¹</button>
                        <button class="nav-btn" onclick="navigateToday()">Today</button>
                        <button class="nav-btn" onclick="navigateWeek(1)">â€º</button>
                    </div>
                    <div class="current-date" id="currentDate">Loading...</div>
                    <div class="view-selector">
                        <button class="view-btn active" onclick="setView('week')">Week</button>
                        <button class="view-btn" onclick="setView('day')">Day</button>
                        <button class="view-btn" onclick="setView('month')">Month</button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading calendar...
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div>
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="connectionStatus">Connecting...</span>
            </div>
            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- New Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">Schedule Service</h2>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="scheduleBtn" onclick="scheduleEvent()">Schedule</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PROXY_API_URL = 'http://localhost:5001/api';
        
        // Global state
        let currentDate = new Date();
        let currentView = 'week';
        let services = [];
        let selectedService = null;
        let selectedMethod = null;
        let selectedDateTime = null;
        let scheduledEvents = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();
            loadServices();
            loadScheduledEvents();
            checkConnection();
            
            // Set date navigator to today
            document.getElementById('dateNavigator').value = formatDateForInput(new Date());
            
            // Periodic updates
            setInterval(checkConnection, 5000);
            setInterval(loadScheduledEvents, 30000);
        });

        function initializeCalendar() {
            renderCalendar();
            updateCurrentDateDisplay();
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function updateCurrentDateDisplay() {
            const dateEl = document.getElementById('currentDate');
            if (currentView === 'week') {
                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                if (weekStart.getMonth() === weekEnd.getMonth()) {
                    dateEl.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                } else {
                    dateEl.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                }
            } else {
                dateEl.textContent = currentDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            
            if (currentView === 'week') {
                renderWeekView(grid);
            } else if (currentView === 'day') {
                renderDayView(grid);
            } else {
                renderMonthView(grid);
            }
            
            // Render events
            renderEvents();
        }

        function renderWeekView(container) {
            const weekStart = getWeekStart(currentDate);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let html = '<div class="week-view">';
            
            // Time column
            html += '<div class="time-column">';
            html += '<div style="height: 60px;"></div>'; // Header space
            for (let hour = 0; hour < 24; hour++) {
                const time = hour === 0 ? '12 AM' : hour < 12 ? `${hour} AM` : 
                           hour === 12 ? '12 PM' : `${hour - 12} PM`;
                html += `<div class="time-slot">${time}</div>`;
            }
            html += '</div>';
            
            // Days container
            html += '<div class="days-container">';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const isToday = isDateToday(date);
                
                html += '<div class="day-column">';
                html += `<div class="day-header">
                    <div class="day-name">${days[i]}</div>
                    <div class="day-number ${isToday ? 'today' : ''}">${date.getDate()}</div>
                </div>`;
                
                // Hour slots
                for (let hour = 0; hour < 24; hour++) {
                    const slotDate = new Date(date);
                    slotDate.setHours(hour, 0, 0, 0);
                    html += `<div class="hour-slot" onclick="showNewEventModal('${slotDate.toISOString()}')"></div>`;
                }
                
                html += '</div>';
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function renderEvents() {
            // Clear existing events
            document.querySelectorAll('.event').forEach(e => e.remove());
            
            // Render scheduled events
            scheduledEvents.forEach(event => {
                renderEvent(event);
            });
        }

        function renderEvent(event) {
            // Parse event date
            const eventDate = new Date(event.scheduled_time);
            
            // Check if event is in current view
            if (!isEventInView(eventDate)) return;
            
            // Find the appropriate slot
            const dayIndex = eventDate.getDay();
            const hour = eventDate.getHours();
            const minutes = eventDate.getMinutes();
            
            const dayColumn = document.querySelectorAll('.day-column')[dayIndex];
            if (!dayColumn) return;
            
            const hourSlot = dayColumn.querySelectorAll('.hour-slot')[hour];
            if (!hourSlot) return;
            
            // Create event element
            const eventEl = document.createElement('div');
            eventEl.className = `event ${getServiceClass(event.service)}`;
            eventEl.style.top = `${60 + hour * 60 + (minutes / 60) * 60}px`;
            eventEl.style.height = '56px'; // Default 1 hour
            
            eventEl.innerHTML = `
                <div class="event-title">${event.service}.${event.method}</div>
                <div class="event-time">${formatTime(eventDate)}</div>
            `;
            
            eventEl.onclick = (e) => {
                e.stopPropagation();
                showEventDetails(event);
            };
            
            dayColumn.appendChild(eventEl);
        }

        function isEventInView(date) {
            if (currentView === 'week') {
                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);
                return date >= weekStart && date < weekEnd;
            }
            // Add other view checks as needed
            return true;
        }

        function getServiceClass(serviceName) {
            if (serviceName.includes('climate')) return 'climate';
            if (serviceName.includes('vehicle')) return 'vehicle';
            if (serviceName.includes('scheduler')) return 'scheduler';
            return '';
        }

        function navigateWeek(direction) {
            currentDate.setDate(currentDate.getDate() + (direction * 7));
            updateCurrentDateDisplay();
            renderCalendar();
        }

        function navigateToday() {
            currentDate = new Date();
            updateCurrentDateDisplay();
            renderCalendar();
        }

        function navigateToDate(dateStr) {
            currentDate = new Date(dateStr);
            updateCurrentDateDisplay();
            renderCalendar();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === view);
            });
            renderCalendar();
        }

        // Service Management
        async function loadServices() {
            try {
                const response = await fetch(`${PROXY_API_URL}/services`);
                const data = await response.json();
                
                services = data.services || [];
                renderServiceList();
            } catch (error) {
                console.error('Failed to load services:', error);
                showStatus('Failed to load services', 'error');
            }
        }

        function renderServiceList() {
            const container = document.getElementById('serviceList');
            
            if (services.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center;">No services found</div>';
                return;
            }
            
            container.innerHTML = services.map(service => {
                const schedulableCount = service.namespaces.reduce((count, ns) => 
                    count + ns.methods.filter(m => m.is_schedulable).length, 0
                );
                
                if (schedulableCount === 0) return '';
                
                return `
                    <div class="service-item" onclick="selectService('${service.name}')">
                        <div class="service-indicator" style="background: ${getServiceColor(service.name)}"></div>
                        <div>
                            <div style="font-weight: 500;">${service.name}</div>
                            <div style="font-size: 12px; color: #999;">${schedulableCount} schedulable methods</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getServiceColor(serviceName) {
            if (serviceName.includes('climate')) return '#34a853';
            if (serviceName.includes('vehicle')) return '#fbbc04';
            if (serviceName.includes('scheduler')) return '#ea4335';
            return '#1a73e8';
        }

        // Event Scheduling
        function showNewEventModal(dateTime) {
            selectedDateTime = dateTime ? new Date(dateTime) : new Date();
            
            const modal = document.getElementById('eventModal');
            const modalBody = document.getElementById('modalBody');
            
            // Reset state
            selectedService = null;
            selectedMethod = null;
            
            // Show service selection
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>When</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="date" id="eventDate" class="form-control" style="flex: 1" 
                               value="${formatDateForInput(selectedDateTime)}">
                        <input type="time" id="eventTime" class="form-control" style="flex: 1"
                               value="${selectedDateTime.toTimeString().slice(0, 5)}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select a service to schedule</label>
                    <div class="service-selection">
                        ${services.map(service => {
                            const methods = [];
                            service.namespaces.forEach(ns => {
                                ns.methods.forEach(method => {
                                    if (method.x_scheduling?.enabled) {
                                        methods.push({ ...method, namespace: ns.name });
                                    }
                                });
                            });
                            
                            if (methods.length === 0) return '';
                            
                            return `
                                <div class="service-option" onclick="selectServiceForScheduling('${service.name}')">
                                    <div class="service-name">${service.name}</div>
                                    <div class="service-description">${service.description || ''}</div>
                                    <div class="method-list" style="display: none;" id="methods-${service.name}">
                                        ${methods.map(method => `
                                            <div class="method-item" onclick="selectMethod('${service.name}', '${method.name}')">
                                                ðŸ“… ${method.name}
                                                ${method.description ? `<div style="font-size: 12px; opacity: 0.7;">${method.description}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div id="parameterSection" style="display: none;">
                    <!-- Parameters will be shown here -->
                </div>
                
                <div class="form-group" style="margin-top: 24px;">
                    <label>Repeat</label>
                    <div class="recurring-options">
                        <div class="recurring-option selected" onclick="selectRecurring(this, 'once')">Does not repeat</div>
                        <div class="recurring-option" onclick="selectRecurring(this, 'daily')">Daily</div>
                        <div class="recurring-option" onclick="selectRecurring(this, 'weekdays')">Weekdays</div>
                        <div class="recurring-option" onclick="selectRecurring(this, 'weekly')">Weekly</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function selectServiceForScheduling(serviceName) {
            // Toggle service selection
            document.querySelectorAll('.service-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            // Show/hide method list
            document.querySelectorAll('.method-list').forEach(list => {
                list.style.display = 'none';
            });
            
            document.getElementById(`methods-${serviceName}`).style.display = 'block';
        }

        function selectMethod(serviceName, methodName) {
            event.stopPropagation();
            
            selectedService = services.find(s => s.name === serviceName);
            selectedMethod = null;
            
            // Find the method
            selectedService.namespaces.forEach(ns => {
                ns.methods.forEach(method => {
                    if (method.name === methodName) {
                        selectedMethod = method;
                    }
                });
            });
            
            // Highlight selected method
            document.querySelectorAll('.method-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show parameters
            showParameterForm();
        }

        function showParameterForm() {
            const section = document.getElementById('parameterSection');
            
            if (!selectedMethod.input_parameters || selectedMethod.input_parameters.length === 0) {
                section.innerHTML = '<p style="color: #666;">This method has no parameters.</p>';
                section.style.display = 'block';
                return;
            }
            
            section.innerHTML = '<h3 style="margin-bottom: 16px;">Parameters</h3>' +
                generateParameterForm(selectedMethod.input_parameters);
            section.style.display = 'block';
        }

        function generateParameterForm(parameters) {
            if (!parameters || parameters.length === 0) {
                return '<p style="color: #666;">This method has no parameters.</p>';
            }
            
            return parameters.map(param => {
                return `<div class="form-group">
                    <label>${param.name} ${param.is_optional ? '(optional)' : ''}</label>
                    ${generateParameterInput(param)}
                </div>`;
            }).join('');
        }

        function generateParameterInput(param) {
            // Handle STRUCT type parameters
            if (param.type === 'STRUCT' && param.struct_type && selectedService.struct_definitions) {
                const structDef = selectedService.struct_definitions[param.struct_type];
                if (structDef) {
                    return `
                        <div class="struct-group" data-struct-name="${param.name}" data-struct-type="${param.struct_type}">
                            ${structDef.members.map(member => generateMemberInput({
                                ...member,
                                name: `${param.name}.${member.name}`,
                                parameterName: member.name
                            }, `${param.name}_${member.name}`)).join('')}
                        </div>
                    `;
                }
            }
            
            // Handle enums
            if (param.enum_values && param.enum_values.length > 0 && param.type !== 'ARRAY') {
                return `
                    <select class="form-control" data-param="${param.name}">
                        ${param.enum_values.map(value => {
                            const match = value.match(/(.+)\s*\((\d+)\)/);
                            if (match) {
                                const [, label, val] = match;
                                return `<option value="${val}">${label}</option>`;
                            }
                            return `<option value="${value}">${value}</option>`;
                        }).join('')}
                    </select>
                `;
            }
            
            // Handle arrays of enums
            if (param.type === 'ARRAY' && param.enum_values) {
                const defaultValues = Array.isArray(param.default_value) ? param.default_value : [];
                return `
                    <div class="enum-array-selector">
                        ${param.enum_values.map(value => {
                            const match = value.match(/(.+)\s*\((\d+)\)/);
                            const enumName = match ? match[1] : value;
                            const enumValue = match ? parseInt(match[2]) : value;
                            const isDefault = defaultValues.includes(enumValue);
                            return `
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" data-param="${param.name}" value="${enumValue}" 
                                           ${isDefault ? 'checked' : ''}>
                                    <span>${enumName}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // Handle other types
            if (param.type === 'BOOLEAN') {
                return `<input type="checkbox" class="form-control" data-param="${param.name}">`;
            } else if (param.type === 'FLOAT' || param.type === 'UINT32') {
                return `<input type="number" class="form-control" data-param="${param.name}" 
                        ${param.min_value ? `min="${param.min_value}"` : ''} 
                        ${param.max_value ? `max="${param.max_value}"` : ''}
                        ${param.type === 'FLOAT' ? 'step="0.1"' : ''}>`;
            } else {
                return `<input type="text" class="form-control" data-param="${param.name}">`;
            }
        }

        function generateMemberInput(member, fieldId) {
            const memberType = getMemberType(member.type);
            
            // Check for nested struct
            if (selectedService.struct_definitions && selectedService.struct_definitions[member.type]) {
                const nestedStructDef = selectedService.struct_definitions[member.type];
                return `
                    <div class="struct-group nested" data-struct-name="${member.name}" data-struct-type="${member.type}">
                        <div class="struct-label">${member.parameterName || member.name}</div>
                        ${nestedStructDef.members.map(nestedMember => generateMemberInput({
                            ...nestedMember,
                            name: `${member.name}.${nestedMember.name}`,
                            parameterName: nestedMember.name
                        }, `${fieldId}_${nestedMember.name}`)).join('')}
                    </div>
                `;
            }
            
            // Handle enum values
            const enumValues = getEnumValues(member.type);
            if (enumValues && memberType !== 'ARRAY') {
                return `
                    <div class="form-group">
                        <label>${member.parameterName || member.name}</label>
                        <select class="form-control" id="${fieldId}" data-parameter-name="${member.parameterName || member.name}">
                            ${enumValues.map(val => {
                                const match = val.match(/(.+)\s*\((\d+)\)/);
                                if (match) {
                                    const [, label, value] = match;
                                    return `<option value="${value}">${label}</option>`;
                                }
                                return `<option value="${val}">${val}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Handle array of enums
            if (memberType === 'ARRAY' && enumValues) {
                const defaultValues = Array.isArray(member.default_value) ? member.default_value : [];
                return `
                    <div class="form-group">
                        <label>${member.parameterName || member.name}</label>
                        <div class="enum-array-selector">
                            ${enumValues.map(value => {
                                const match = value.match(/(.+)\s*\((\d+)\)/);
                                const enumName = match ? match[1] : value;
                                const enumValue = match ? parseInt(match[2]) : value;
                                const isDefault = defaultValues.includes(enumValue);
                                return `
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" data-parameter-name="${member.parameterName || member.name}"
                                               data-array-enum="true" value="${enumValue}" ${isDefault ? 'checked' : ''}>
                                        <span>${enumName}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Regular input
            return `
                <div class="form-group">
                    <label>${member.parameterName || member.name}</label>
                    <input type="${memberType === 'BOOLEAN' ? 'checkbox' : memberType === 'FLOAT' || memberType === 'UINT32' ? 'number' : 'text'}" 
                           class="form-control" id="${fieldId}" 
                           data-parameter-name="${member.parameterName || member.name}"
                           ${member.default_value ? `value="${member.default_value}"` : ''}>
                </div>
            `;
        }

        function getMemberType(ifexType) {
            if (ifexType === 'float' || ifexType === 'double') return 'FLOAT';
            if (ifexType.includes('uint')) return 'UINT32';
            if (ifexType.includes('int')) return 'INT32';
            if (ifexType === 'boolean') return 'BOOLEAN';
            if (ifexType === 'string') return 'STRING';
            if (ifexType.endsWith('[]')) return 'ARRAY';
            return 'STRING';
        }

        function getEnumValues(ifexType) {
            if (selectedService.enum_definitions && selectedService.enum_definitions[ifexType]) {
                const enumDef = selectedService.enum_definitions[ifexType];
                return enumDef.options.map(opt => `${opt.name} (${opt.value})`);
            }
            // Handle array of enums
            if (ifexType.endsWith('[]')) {
                const baseType = ifexType.slice(0, -2);
                if (selectedService.enum_definitions && selectedService.enum_definitions[baseType]) {
                    const enumDef = selectedService.enum_definitions[baseType];
                    return enumDef.options.map(opt => `${opt.name} (${opt.value})`);
                }
            }
            return null;
        }

        function collectParameters(parameters) {
            const result = {};
            
            if (!parameters || parameters.length === 0) {
                return result;
            }
            
            parameters.forEach(param => {
                if (param.type === 'STRUCT' && param.struct_type) {
                    const structGroup = document.querySelector(`[data-struct-name="${param.name}"]`);
                    if (structGroup) {
                        result[param.name] = collectStructData(structGroup);
                    }
                } else if (param.type === 'ARRAY' && param.enum_values) {
                    // Array of enums - collect checked checkboxes
                    const checkboxes = document.querySelectorAll(`[data-param="${param.name}"]:checked`);
                    result[param.name] = Array.from(checkboxes).map(cb => parseInt(cb.value));
                } else {
                    const input = document.querySelector(`[data-param="${param.name}"]`);
                    if (input) {
                        result[param.name] = getInputValue(input);
                    }
                }
            });
            
            return result;
        }

        function collectStructData(structGroup) {
            const structData = {};
            
            // Handle array enum checkboxes
            const arrayEnumGroups = {};
            structGroup.querySelectorAll('[data-array-enum="true"]').forEach(checkbox => {
                const fieldName = checkbox.getAttribute('data-parameter-name');
                if (!arrayEnumGroups[fieldName]) {
                    arrayEnumGroups[fieldName] = [];
                }
                if (checkbox.checked) {
                    arrayEnumGroups[fieldName].push(parseInt(checkbox.value));
                }
            });
            
            Object.entries(arrayEnumGroups).forEach(([fieldName, values]) => {
                structData[fieldName] = values;
            });
            
            // Handle regular inputs
            structGroup.querySelectorAll('[data-parameter-name]').forEach(input => {
                if (input.hasAttribute('data-array-enum')) return;
                
                const parentStruct = input.closest('[data-struct-name]');
                if (parentStruct !== structGroup) return;
                
                const fieldName = input.getAttribute('data-parameter-name');
                if (!structData.hasOwnProperty(fieldName)) {
                    structData[fieldName] = getInputValue(input);
                }
            });
            
            // Handle nested structs
            structGroup.querySelectorAll('[data-struct-name]').forEach(nestedGroup => {
                const parentGroup = nestedGroup.parentElement.closest('[data-struct-name]');
                if (parentGroup === structGroup) {
                    const nestedStructName = nestedGroup.getAttribute('data-struct-name');
                    const fieldName = nestedStructName.split('.').pop();
                    structData[fieldName] = collectStructData(nestedGroup);
                }
            });
            
            return structData;
        }

        function getInputValue(input) {
            if (input.type === 'checkbox' && !input.hasAttribute('data-array-enum')) {
                return input.checked;
            } else if (input.type === 'select-one') {
                return parseInt(input.value) || input.value;
            } else if (input.type === 'number') {
                return parseFloat(input.value) || 0;
            } else {
                return input.value;
            }
        }

        function selectRecurring(element, value) {
            document.querySelectorAll('.recurring-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        async function scheduleEvent() {
            if (!selectedService || !selectedMethod) {
                alert('Please select a service and method');
                return;
            }
            
            // Get date and time
            const eventDate = document.getElementById('eventDate').value;
            const eventTime = document.getElementById('eventTime').value;
            
            // Get recurring option
            const recurring = document.querySelector('.recurring-option.selected').textContent === 'Does not repeat' 
                ? 'once' : document.querySelector('.recurring-option.selected').textContent.toLowerCase();
            
            // Collect parameters
            const parameters = collectParameters(selectedMethod.input_parameters);
            
            // Create schedule request
            const scheduleData = {
                service: selectedService.name,
                method: selectedMethod.name,
                date: eventDate,
                time: eventTime,
                recurring: recurring,
                parameters: parameters,
                service_address: selectedService.address
            };
            
            try {
                const response = await fetch(`${PROXY_API_URL}/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('Event scheduled successfully', 'success');
                    closeModal();
                    loadScheduledEvents();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to schedule');
                }
            } catch (error) {
                showStatus(`Failed to schedule: ${error.message}`, 'error');
            }
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Event Management
        async function loadScheduledEvents() {
            try {
                const response = await fetch(`${PROXY_API_URL}/jobs`);
                const data = await response.json();
                
                scheduledEvents = data.jobs || [];
                renderEvents();
            } catch (error) {
                console.error('Failed to load events:', error);
            }
        }

        function showEventDetails(event) {
            // TODO: Show event details modal with delete option
            console.log('Event details:', event);
        }

        // Connection Management
        async function checkConnection() {
            try {
                const response = await fetch(`${PROXY_API_URL}/health`);
                if (response.ok) {
                    document.getElementById('statusIndicator').classList.remove('offline');
                    document.getElementById('connectionStatus').textContent = 'Connected';
                } else {
                    throw new Error('Service offline');
                }
            } catch (error) {
                document.getElementById('statusIndicator').classList.add('offline');
                document.getElementById('connectionStatus').textContent = 'Disconnected';
            }
        }

        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.style.color = type === 'error' ? '#ea4335' : '#34a853';
            
            setTimeout(() => {
                statusMessage.textContent = '';
            }, 5000);
        }

        async function refreshServices() {
            await loadServices();
            await loadScheduledEvents();
            showStatus('Refreshed', 'success');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>