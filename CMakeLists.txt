cmake_minimum_required(VERSION 3.16)
project(ifex-ecosystem VERSION 0.1.0 LANGUAGES CXX)

# C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Find common dependencies at top level
find_package(Threads REQUIRED)
find_package(Protobuf REQUIRED)
find_package(gRPC REQUIRED)
find_package(glog REQUIRED)
find_package(gflags REQUIRED)
find_package(nlohmann_json REQUIRED)
find_package(yaml-cpp REQUIRED)

# Options
option(BUILD_CORE "Build IFEX core library" ON)
option(BUILD_REFERENCE_SERVICES "Build reference services" ON)
option(BUILD_TEST_SERVICES "Build test services" ON)
option(BUILD_INTEGRATION_TESTS "Build integration tests" ON)
option(BUILD_SHARED_LIBS "Build shared libraries" OFF)

# Export compile commands for IDEs
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Find gRPC plugin for proto generation
find_program(GRPC_CPP_PLUGIN_EXECUTABLE grpc_cpp_plugin)
if(NOT GRPC_CPP_PLUGIN_EXECUTABLE)
    message(FATAL_ERROR "grpc_cpp_plugin not found")
endif()

# Build protobuf generation first if we're building core or services
if(BUILD_CORE OR BUILD_REFERENCE_SERVICES OR BUILD_TEST_SERVICES)
    # Proto directory (generated by generate_proto.sh)
    set(PROTO_DIR ${CMAKE_SOURCE_DIR}/proto)

    # Check if proto files exist
    if(NOT EXISTS ${PROTO_DIR}/service-discovery-service.proto)
        message(FATAL_ERROR "Proto files not found in ${PROTO_DIR}. Please run ./generate_proto.sh first.")
    endif()

    # Find all proto files
    file(GLOB PROTO_FILES ${PROTO_DIR}/*.proto)

    # Generate C++ sources from proto files
    set(PROTO_SRCS)
    set(PROTO_HDRS)
    set(GRPC_SRCS)
    set(GRPC_HDRS)

    foreach(proto_file ${PROTO_FILES})
        get_filename_component(proto_name ${proto_file} NAME_WE)

        set(proto_src "${CMAKE_BINARY_DIR}/proto/${proto_name}.pb.cc")
        set(proto_hdr "${CMAKE_BINARY_DIR}/proto/${proto_name}.pb.h")
        set(grpc_src "${CMAKE_BINARY_DIR}/proto/${proto_name}.grpc.pb.cc")
        set(grpc_hdr "${CMAKE_BINARY_DIR}/proto/${proto_name}.grpc.pb.h")

        add_custom_command(
            OUTPUT ${proto_src} ${proto_hdr} ${grpc_src} ${grpc_hdr}
            COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/proto
            COMMAND ${Protobuf_PROTOC_EXECUTABLE}
            ARGS --grpc_out=${CMAKE_BINARY_DIR}/proto
                 --cpp_out=${CMAKE_BINARY_DIR}/proto
                 --plugin=protoc-gen-grpc=${GRPC_CPP_PLUGIN_EXECUTABLE}
                 -I ${PROTO_DIR}
                 ${proto_file}
            DEPENDS ${proto_file}
            COMMENT "Generating C++ code from ${proto_file}"
        )

        list(APPEND PROTO_SRCS ${proto_src})
        list(APPEND PROTO_HDRS ${proto_hdr})
        list(APPEND GRPC_SRCS ${grpc_src})
        list(APPEND GRPC_HDRS ${grpc_hdr})
    endforeach()

    # Create library for generated proto code
    add_library(ifex-proto-generated STATIC
        ${PROTO_SRCS}
        ${GRPC_SRCS}
    )

    target_include_directories(ifex-proto-generated
        PUBLIC
            $<BUILD_INTERFACE:${CMAKE_BINARY_DIR}/proto>
    )

    target_link_libraries(ifex-proto-generated
        PUBLIC
            protobuf::libprotobuf
            gRPC::grpc++
    )

    # Install the proto library (needed for export set)
    include(GNUInstallDirs)
    install(TARGETS ifex-proto-generated
        EXPORT ifex-core-targets
        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    )
endif()

# Core library - depends on generated protobuf
if(BUILD_CORE)
    add_subdirectory(core)
endif()

# Reference services - depend on core
if(BUILD_REFERENCE_SERVICES)
    if(NOT BUILD_CORE)
        message(FATAL_ERROR "Reference services require core library")
    endif()
    add_subdirectory(reference-services)
endif()

# Test services - depend on core
if(BUILD_TEST_SERVICES)
    if(NOT BUILD_CORE)
        message(FATAL_ERROR "Test services require core library")
    endif()
    add_subdirectory(test-services)
endif()

# Test client
if(BUILD_TEST_SERVICES OR BUILD_REFERENCE_SERVICES)
    add_subdirectory(test-client)
endif()

# Tests - includes both unit and integration tests
if(BUILD_TESTS OR BUILD_INTEGRATION_TESTS)
    enable_testing()
    find_package(GTest REQUIRED)
    add_subdirectory(tests)
endif()
